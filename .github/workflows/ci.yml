name: CI - Build + Regression + Smoke

on:
  push:
    branches: [ "main", "restore/**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        shell: powershell
        run: npm ci

      - name: Build
        shell: powershell
        run: npm run build

      - name: Start Azurite (Tables)
        shell: powershell
        run: |
          npm run azurite:tables --silent -- --location .azurite --debug .azurite\debug.log
        timeout-minutes: 2

      - name: Wait for Azurite Table port 10002
        shell: powershell
        run: |
          $max = 60
          for ($i = 1; $i -le $max; $i++) {
            $conn = Get-NetTCPConnection -LocalPort 10002 -State Listen -ErrorAction SilentlyContinue
            if ($conn) { Write-Host "Azurite tables listening on 10002"; exit 0 }
            Start-Sleep -Seconds 1
          }
          Write-Error "Azurite tables port 10002 did not open in time"
          exit 1
        timeout-minutes: 2

      - name: Start Functions host
        shell: powershell
        env:
          FUNCTIONS_WORKER_RUNTIME: node
          AzureWebJobsStorage: UseDevelopmentStorage=true
          STORAGE_CONNECTION_STRING: UseDevelopmentStorage=true
          HOPE_API_KEY: ${{ secrets.HOPE_API_KEY }}
        run: |
          $global:funcLog = Join-Path $PWD ("_func_" + (Get-Date -Format "yyyyMMdd_HHmmss") + ".log")
          Write-Host "funcLog=$global:funcLog"
          Start-Process -FilePath "func" -ArgumentList @("start","--port","7071") -NoNewWindow -RedirectStandardOutput $global:funcLog -RedirectStandardError $global:funcLog
        timeout-minutes: 2

      - name: Wait for Functions host port 7071
        shell: powershell
        run: |
          $max = 60
          for ($i = 1; $i -le $max; $i++) {
            $conn = Get-NetTCPConnection -LocalPort 7071 -State Listen -ErrorAction SilentlyContinue
            if ($conn) { Write-Host "Functions host listening on 7071"; exit 0 }
            Start-Sleep -Seconds 1
          }
          Write-Error "Functions host port 7071 did not open in time"
          if ($global:funcLog -and (Test-Path $global:funcLog)) {
            Write-Host "==== func log tail ===="
            Get-Content $global:funcLog -Tail 200
          }
          exit 1
        timeout-minutes: 3

      - name: Regression
        shell: powershell
        env:
          HOPE_API_KEY: ${{ secrets.HOPE_API_KEY }}
        run: powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\regression.ps1
        timeout-minutes: 10

      - name: Smoke
        shell: powershell
        env:
          HOPE_API_KEY: ${{ secrets.HOPE_API_KEY }}
        run: powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\smoke.ps1
        timeout-minutes: 10

      - name: Dump logs on failure
        if: failure()
        shell: powershell
        run: |
          if (Test-Path .azurite\debug.log) {
            Write-Host "==== azurite debug.log tail ===="
            Get-Content .azurite\debug.log -Tail 200
          }
          if ($global:funcLog -and (Test-Path $global:funcLog)) {
            Write-Host "==== func log tail ===="
            Get-Content $global:funcLog -Tail 200
          }
