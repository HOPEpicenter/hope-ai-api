name: CI - Build + Regression + Smoke

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build-and-smoke:
    runs-on: windows-latest

    env:
      NODE_ENV: test
      # Express app expects this key for smoke script requests
      HOPE_API_KEY: ${{ secrets.HOPE_API_KEY }}

      # Storage for Azurite (Tables/Blob/Queue) via local emulator
      AzureWebJobsStorage: UseDevelopmentStorage=true
      STORAGE_CONNECTION_STRING: UseDevelopmentStorage=true

      # Express port
      PORT: "3000"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (npm ci)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          npm ci

      - name: Build (tsc)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          npm run build

      - name: Start Azurite (Blob/Queue/Table)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Install Azurite (avoid npx flakiness on Windows runners)
          npm i -g azurite

          # Find Azurite JS entrypoint in global node_modules
          $globalRoot = (npm root -g).Trim()
          $azJs = Join-Path $globalRoot "azurite\dist\src\azurite.js"
          if (-not (Test-Path $azJs)) { throw "Azurite entrypoint not found at $azJs" }

          $azDir = Join-Path $env:RUNNER_TEMP "azurite"
          New-Item -ItemType Directory -Force -Path $azDir | Out-Null
          $azLog = Join-Path $env:RUNNER_TEMP "azurite.log"

          # Start Azurite (blob/queue/table)
          $p = Start-Process -FilePath "node" -ArgumentList @(
            $azJs,
            "--silent",
            "--location", $azDir,
            "--debug", $azLog,
            "--blobHost","127.0.0.1","--blobPort","10000",
            "--queueHost","127.0.0.1","--queuePort","10001",
            "--tableHost","127.0.0.1","--tablePort","10002"
          ) -WindowStyle Hidden -PassThru

          function Wait-Port([int]$port, [int]$seconds = 180) {
            $deadline = (Get-Date).AddSeconds($seconds)
            while ((Get-Date) -lt $deadline) {
              $ok = Test-NetConnection -ComputerName 127.0.0.1 -Port $port -WarningAction SilentlyContinue
              if ($ok.TcpTestSucceeded) { return $true }
              Start-Sleep -Milliseconds 250
            }
            return $false
          }

          if (-not (Wait-Port 10002 180)) {
            Write-Host "==== AZURITE LOG (tail 200) ===="
            if (Test-Path $azLog) { Get-Content $azLog -Tail 200 }
            if ($p -and $p.HasExited) { Write-Host "Azurite exited early with code $($p.ExitCode)" }
            throw "Azurite Table port 10002 did not open."
          }

          "OK: Azurite tables is listening on 127.0.0.1:10002" | Write-Host

      - name: Start Express server
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $logDir = Join-Path $env:RUNNER_TEMP "express"
          New-Item -ItemType Directory -Force -Path $logDir | Out-Null

          $outLog = Join-Path $logDir "express.out.log"
          $errLog = Join-Path $logDir "express.err.log"

          # Export log paths so later steps (smoke) can dump them on failure
          "EXPRESS_OUT_LOG=$outLog" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "EXPRESS_ERR_LOG=$errLog" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # Start Express (build output). Adjust if your entrypoint differs.
          $p = Start-Process -FilePath "node" -ArgumentList @("dist/index.js") `
            -WindowStyle Hidden `
            -RedirectStandardOutput $outLog `
            -RedirectStandardError  $errLog `
            -PassThru

          function Wait-Port([int]$port, [int]$seconds = 60) {
            $deadline = (Get-Date).AddSeconds($seconds)
            while ((Get-Date) -lt $deadline) {
              $ok = Test-NetConnection -ComputerName 127.0.0.1 -Port $port -WarningAction SilentlyContinue
              if ($ok.TcpTestSucceeded) { return $true }
              Start-Sleep -Milliseconds 250
            }
            return $false
          }

          if (-not (Wait-Port 3000 60)) {
            Write-Host "==== EXPRESS OUT (tail 200) ====" -ForegroundColor Yellow
            if (Test-Path $outLog) { Get-Content $outLog -Tail 200 }
            Write-Host "==== EXPRESS ERR (tail 200) ====" -ForegroundColor Yellow
            if (Test-Path $errLog) { Get-Content $errLog -Tail 200 }
            if ($p -and $p.HasExited) { Write-Host "Express exited early with code $($p.ExitCode)" }
            throw "Express port 3000 did not open."
          }

          "OK: Express is listening on 127.0.0.1:3000" | Write-Host
      - name: Smoke (ci-smoke-express.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          .\scripts\ci-smoke-express.ps1
      - name: Dump Express logs (on failure)
        if: failure()
        shell: pwsh
        run: |
          Write-Host "==== EXPRESS OUT (tail 200) ====" -ForegroundColor Yellow
          if ($env:EXPRESS_OUT_LOG -and (Test-Path $env:EXPRESS_OUT_LOG)) { Get-Content $env:EXPRESS_OUT_LOG -Tail 200 }
          Write-Host "==== EXPRESS ERR (tail 200) ====" -ForegroundColor Yellow
          if ($env:EXPRESS_ERR_LOG -and (Test-Path $env:EXPRESS_ERR_LOG)) { Get-Content $env:EXPRESS_ERR_LOG -Tail 200 }
