name: CI - Build + Regression + Smoke

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build-and-smoke:
    runs-on: windows-latest

    env:
      NODE_ENV: test
      # Express app expects this key for smoke script requests
      HOPE_API_KEY: ${{ secrets.HOPE_API_KEY }}

      # Storage for Azurite (Tables/Blob/Queue) via local emulator
      AzureWebJobsStorage: UseDevelopmentStorage=true
      STORAGE_CONNECTION_STRING: UseDevelopmentStorage=true

      # Express port
      PORT: "3000"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (npm ci)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          npm ci

      - name: Build (tsc)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          npm run build

      - name: Start Azurite (Blob/Queue/Table)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Install Azurite (avoid npx flakiness on Windows runners)
          npm i -g azurite

          # Find Azurite JS entrypoint in global node_modules
          $globalRoot = (npm root -g).Trim()
          $azJs = Join-Path $globalRoot "azurite\dist\src\azurite.js"
          if (-not (Test-Path $azJs)) { throw "Azurite entrypoint not found at $azJs" }

          $azDir = Join-Path $env:RUNNER_TEMP "azurite"
          New-Item -ItemType Directory -Force -Path $azDir | Out-Null
          $azLog = Join-Path $env:RUNNER_TEMP "azurite.log"

          # Start Azurite (blob/queue/table)
          $p = Start-Process -FilePath "node" -ArgumentList @(
            $azJs,
            "--silent",
            "--location", $azDir,
            "--debug", $azLog,
            "--blobHost","127.0.0.1","--blobPort","10000",
            "--queueHost","127.0.0.1","--queuePort","10001",
            "--tableHost","127.0.0.1","--tablePort","10002"
          ) -WindowStyle Hidden -PassThru

          function Wait-Port([int]$port, [int]$seconds = 180) {
            $deadline = (Get-Date).AddSeconds($seconds)
            while ((Get-Date) -lt $deadline) {
              $ok = Test-NetConnection -ComputerName 127.0.0.1 -Port $port -WarningAction SilentlyContinue
              if ($ok.TcpTestSucceeded) { return $true }
              Start-Sleep -Milliseconds 250
            }
            return $false
          }

          if (-not (Wait-Port 10002 180)) {
            Write-Host "==== AZURITE LOG (tail 200) ===="
            if (Test-Path $azLog) { Get-Content $azLog -Tail 200 }
            if ($p -and $p.HasExited) { Write-Host "Azurite exited early with code $($p.ExitCode)" }
            throw "Azurite Table port 10002 did not open."
          }

          "OK: Azurite tables is listening on 127.0.0.1:10002" | Write-Host

      - name: Start Express server
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Run compiled JS to match production-ish behavior
          # Assumes tsc outputs dist/index.js
          $appLog = Join-Path $env:RUNNER_TEMP "app.log"

          Start-Process -FilePath "node" -ArgumentList @("dist/index.js") -RedirectStandardOutput $appLog -RedirectStandardError $appLog -WindowStyle Hidden

          function Wait-Http([string]$url, [int]$seconds = 30) {
            $deadline = (Get-Date).AddSeconds($seconds)
            while ((Get-Date) -lt $deadline) {
              try {
                $r = Invoke-WebRequest -Uri $url -Method Get -TimeoutSec 2 -UseBasicParsing
                if ($r.StatusCode -ge 200 -and $r.StatusCode -lt 500) { return $true }
              } catch {}
              Start-Sleep -Milliseconds 300
            }
            return $false
          }

          if (-not (Wait-Http "http://127.0.0.1:3000/api/visitors?limit=1" 30)) {
            Write-Host "==== APP LOG (tail 200) ===="
            if (Test-Path $appLog) { Get-Content $appLog -Tail 200 }
            throw "Express server did not become reachable on :3000."
          }

          "OK: Express is reachable on http://127.0.0.1:3000" | Write-Host

      - name: Smoke (dev-smoke.ps1)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          .\scripts\dev-smoke.ps1
