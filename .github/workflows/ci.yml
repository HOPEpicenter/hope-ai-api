      - name: Start Host + Run Regression + Run Smoke (single step)
        shell: powershell
        env:
          HOPE_API_KEY: ci-key
          FUNCTIONS_WORKER_RUNTIME: node

          STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
          AzureWebJobsStorage: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
          NODE_ENV: "development"
        run: |
          $ErrorActionPreference = "Stop"

          $logDir = Join-Path $env:RUNNER_TEMP "func"
          New-Item -ItemType Directory -Force -Path $logDir | Out-Null
          $funcOut = Join-Path $logDir "func.out.log"
          $funcErr = Join-Path $logDir "func.err.log"

          $azLog = Join-Path $env:RUNNER_TEMP "azurite\azurite.log"

          function Dump-Logs {
            Write-Host "==== FUNC OUT (tail 200) ====" -ForegroundColor Yellow
            if (Test-Path $funcOut) { Get-Content $funcOut -Tail 200 | ForEach-Object { Write-Host $_ } } else { Write-Host "(missing $funcOut)" }
            Write-Host "==== FUNC ERR (tail 200) ====" -ForegroundColor Yellow
            if (Test-Path $funcErr) { Get-Content $funcErr -Tail 200 | ForEach-Object { Write-Host $_ } } else { Write-Host "(missing $funcErr)" }
            Write-Host "==== AZURITE LOG (tail 200) ====" -ForegroundColor Yellow
            if (Test-Path $azLog) { Get-Content $azLog -Tail 200 | ForEach-Object { Write-Host $_ } } else { Write-Host "(missing $azLog)" }
          }

          $funcExe = (Get-Command func -ErrorAction Stop).Source
          Write-Host "Starting Functions host using: $funcExe"

          $p = $null
          try {
            if ($funcExe.ToLower().EndsWith(".ps1")) {
              $args = @("-NoProfile","-ExecutionPolicy","Bypass","-File",$funcExe,"start","--port","7071")
              $p = Start-Process -FilePath "powershell" -ArgumentList $args -WindowStyle Hidden -RedirectStandardOutput $funcOut -RedirectStandardError $funcErr -PassThru
            } else {
              $p = Start-Process -FilePath $funcExe -ArgumentList "start","--port","7071" -WindowStyle Hidden -RedirectStandardOutput $funcOut -RedirectStandardError $funcErr -PassThru
            }

            $base = "http://127.0.0.1:7071/api"
            $headers = @{ "x-api-key" = $env:HOPE_API_KEY }

            # ---- Host readiness probe (kept) ----
            $deadline = (Get-Date).AddSeconds(240)
            do {
              try {
                Invoke-RestMethod -Method Post -Uri "$base/visitors" -Headers $headers -ContentType "application/json" -Body '{"name":"ci-ready","email":"ci-ready@example.com","source":"ci"}' -TimeoutSec 10 | Out-Null
                Write-Host "Host ready via POST /visitors"
                break
              } catch {
                Start-Sleep -Milliseconds 900
              }

              if ($p.HasExited) {
                Write-Host "Host exited early." -ForegroundColor Yellow
                Dump-Logs
                throw "Functions host exited before becoming ready."
              }
            } while ((Get-Date) -lt $deadline)

            if ((Get-Date) -ge $deadline) {
              Write-Host "Host not ready in time." -ForegroundColor Yellow
              Dump-Logs
              throw "Functions host did not become ready in time."
            }

            # ---- NEW: storage warmup (handles CI flakiness) ----
            # Weâ€™ve seen cases where the host is up but Azurite/table calls still fail for a few seconds.
            $warmDeadline = (Get-Date).AddSeconds(60)
            $warmOk = $false
            do {
              try {
                Invoke-RestMethod -Method Post -Uri "$base/visitors" -Headers $headers -ContentType "application/json" -Body '{"name":"ci-warm","email":"ci-warm@example.com","source":"ci"}' -TimeoutSec 10 | Out-Null
                $warmOk = $true
                Write-Host "Storage warmup OK via POST /visitors"
              } catch {
                Start-Sleep -Milliseconds 900
              }
            } while (-not $warmOk -and (Get-Date) -lt $warmDeadline)

            if (-not $warmOk) {
              Write-Host "Storage warmup failed (POST /visitors never succeeded reliably)." -ForegroundColor Yellow
              Dump-Logs
              throw "Storage warmup failed."
            }

            # ---- Run tests; on failure dump logs ----
            try {
              powershell -ExecutionPolicy Bypass -File .\scripts\regression.ps1 -BaseUrl $base
              powershell -ExecutionPolicy Bypass -File .\scripts\smoke.ps1 -BaseUrl $base
            } catch {
              Write-Host "Regression/Smoke failed. Dumping logs..." -ForegroundColor Yellow
              Dump-Logs
              throw
            }

          } finally {
            if ($p -and -not $p.HasExited) {
              Write-Host "Stopping Functions host (pid=$($p.Id))"
              Stop-Process -Id $p.Id -Force
            }
          }
