name: CI - Build + Regression + Smoke

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        shell: powershell
        run: |
          npm ci

      - name: Build (tsc)
        shell: powershell
        run: |
          npm run build

      - name: Start Azurite (npx)
        shell: powershell
        run: |
          $azDir = Join-Path $env:RUNNER_TEMP "azurite"
          New-Item -ItemType Directory -Force -Path $azDir | Out-Null
          $azLog = Join-Path $azDir "azurite.log"

          # Bind explicitly to 127.0.0.1
          $args = @(
            "-y","azurite",
            "--silent",
            "--location",$azDir,
            "--debug",$azLog,
            "--blobHost","127.0.0.1",
            "--queueHost","127.0.0.1",
            "--tableHost","127.0.0.1"
          )

          Start-Process -FilePath "npx" -ArgumentList $args -WindowStyle Hidden
          Start-Sleep -Seconds 2
          Write-Host "Azurite started. Log at $azLog"

      - name: Install Azure Functions Core Tools v4 (npm)
        shell: powershell
        run: |
          npm i -g azure-functions-core-tools@4 --unsafe-perm true
          $npmBin = npm bin -g
          "NPM_GLOBAL_BIN=$npmBin" | Out-File -FilePath $env:GITHUB_ENV -Append
          $npmBin | Out-File -FilePath $env:GITHUB_PATH -Append

          $cmd = Get-Command func -ErrorAction Stop
          Write-Host "func command type: $($cmd.CommandType)"
          Write-Host "func source:       $($cmd.Source)"
          func --version

      - name: Start Functions Host (capture logs)
        shell: powershell
        env:
          HOPE_API_KEY: ci-key
          FUNCTIONS_WORKER_RUNTIME: node

          # OFFICIAL Azurite dev connection string (key must match Azurite)
          STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
          AzureWebJobsStorage: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"

          NODE_ENV: "development"
        run: |
          $logDir = Join-Path $env:RUNNER_TEMP "func"
          New-Item -ItemType Directory -Force -Path $logDir | Out-Null
          $funcOut = Join-Path $logDir "func.out.log"
          $funcErr = Join-Path $logDir "func.err.log"

          $funcExe = (Get-Command func -ErrorAction Stop).Source
          Write-Host "Starting Functions host using: $funcExe"

          if ($funcExe.ToLower().EndsWith(".ps1")) {
            $args = @("-NoProfile","-ExecutionPolicy","Bypass","-File",$funcExe,"start","--port","7071")
            $p = Start-Process -FilePath "powershell" -ArgumentList $args -WindowStyle Hidden -RedirectStandardOutput $funcOut -RedirectStandardError $funcErr -PassThru
          } else {
            $p = Start-Process -FilePath $funcExe -ArgumentList "start","--port","7071" -WindowStyle Hidden -RedirectStandardOutput $funcOut -RedirectStandardError $funcErr -PassThru
          }

          $base = "http://127.0.0.1:7071/api"
          $headers = @{ "x-api-key" = $env:HOPE_API_KEY }

          $deadline = (Get-Date).AddSeconds(150)
          do {
            try {
              Invoke-RestMethod -Method Post -Uri "$base/visitors" -Headers $headers -ContentType "application/json" -Body '{"name":"ci","email":"ci@example.com","source":"ci"}' -TimeoutSec 5 | Out-Null
              Write-Host "Functions host is up via /visitors"
              break
            } catch {
              Start-Sleep -Milliseconds 900
            }

            if ($p.HasExited) {
              Write-Host "Functions host exited early. Last 120 lines of func.out.log:" -ForegroundColor Yellow
              if (Test-Path $funcOut) { Get-Content $funcOut -Tail 120 | ForEach-Object { Write-Host $_ } }
              Write-Host "Last 120 lines of func.err.log:" -ForegroundColor Yellow
              if (Test-Path $funcErr) { Get-Content $funcErr -Tail 120 | ForEach-Object { Write-Host $_ } }
              throw "Functions host exited before becoming ready."
            }
          } while ((Get-Date) -lt $deadline)

          if ((Get-Date) -ge $deadline) {
            Write-Host "Functions host did not become ready. Last 120 lines of func.out.log:" -ForegroundColor Yellow
            if (Test-Path $funcOut) { Get-Content $funcOut -Tail 120 | ForEach-Object { Write-Host $_ } }
            Write-Host "Last 120 lines of func.err.log:" -ForegroundColor Yellow
            if (Test-Path $funcErr) { Get-Content $funcErr -Tail 120 | ForEach-Object { Write-Host $_ } }
            throw "Functions host did not become ready in time."
          }

      - name: Run Regression
        shell: powershell
        env:
          HOPE_API_KEY: ci-key
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\regression.ps1 -BaseUrl "http://127.0.0.1:7071/api"

      - name: Run Smoke
        shell: powershell
        env:
          HOPE_API_KEY: ci-key
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\smoke.ps1 -BaseUrl "http://127.0.0.1:7071/api"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            ${{ runner.temp }}\azurite\azurite.log
            ${{ runner.temp }}\func\func.out.log
            ${{ runner.temp }}\func\func.err.log
