name: CI - Build + Regression + Smoke

on:
  push:
    branches: ["main", "chore/**"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_test:
    name: test
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        shell: powershell
        run: |
          npm ci

      - name: Start Azurite (blob/queue/table)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $azDir = Join-Path $env:RUNNER_TEMP "azurite"
          New-Item -ItemType Directory -Force -Path $azDir | Out-Null
          $azLog = Join-Path $azDir "azurite.log"

          $args = @(
            "-y","azurite",
            "--silent",
            "--location",$azDir,
            "--debug",$azLog,
            "--blobHost","127.0.0.1",
            "--queueHost","127.0.0.1",
            "--tableHost","127.0.0.1"
          )

          Start-Process -FilePath "npx" -ArgumentList $args -WindowStyle Hidden | Out-Null
          Start-Sleep -Seconds 2

          Write-Host "Azurite started. Log at: $azLog"

      - name: Install Azure Functions Core Tools v4
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          npm i -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Build (TypeScript)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          npm run build

      - name: Start Functions host + run regression + smoke
        shell: powershell
        env:
          # Use repo secret (create this in Settings -> Secrets -> Actions)
          HOPE_API_KEY: ${{ secrets.HOPE_API_KEY }}

          # Functions runtime
          FUNCTIONS_WORKER_RUNTIME: node
          NODE_ENV: development

          # Azurite connection strings (safe, standard devstoreaccount1)
          STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
          AzureWebJobsStorage: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"

          # Disable timer-triggered function in CI (avoids host startup flakiness)
          AzureWebJobs.autoAssignFollowupTimer.Disabled: "true"
        run: |
          $ErrorActionPreference = "Stop"

          $logDir = Join-Path $env:RUNNER_TEMP "func"
          New-Item -ItemType Directory -Force -Path $logDir | Out-Null
          $funcOut = Join-Path $logDir "func.out.log"
          $funcErr = Join-Path $logDir "func.err.log"

          $funcExe = (Get-Command func -ErrorAction Stop).Source
          Write-Host "Starting Functions host using: $funcExe"

          $p = $null
          try {
            if ($funcExe.ToLower().EndsWith(".ps1")) {
              $args = @("-NoProfile","-ExecutionPolicy","Bypass","-File",$funcExe,"start","--port","7071")
              $p = Start-Process -FilePath "powershell" -ArgumentList $args -WindowStyle Hidden -RedirectStandardOutput $funcOut -RedirectStandardError $funcErr -PassThru
            } else {
              $p = Start-Process -FilePath $funcExe -ArgumentList "start","--port","7071" -WindowStyle Hidden -RedirectStandardOutput $funcOut -RedirectStandardError $funcErr -PassThru
            }

            $base = "http://127.0.0.1:7071/api"
            $headers = @{ "x-api-key" = $env:HOPE_API_KEY }

            $deadline = (Get-Date).AddSeconds(240)
            $ready = $false

            do {
              try {
                Invoke-RestMethod -Method Post -Uri "$base/visitors" -Headers $headers -ContentType "application/json" -Body '{"name":"ci","email":"ci@example.com","source":"ci"}' -TimeoutSec 10 | Out-Null
                Write-Host "Host ready via POST /visitors"
                $ready = $true
                break
              } catch {
                Start-Sleep -Milliseconds 900
              }

              if ($p.HasExited) {
                Write-Host "Host exited early. Last 200 lines of func.out.log:" -ForegroundColor Yellow
                if (Test-Path $funcOut) { Get-Content $funcOut -Tail 200 | ForEach-Object { Write-Host $_ } }
                Write-Host "Last 200 lines of func.err.log:" -ForegroundColor Yellow
                if (Test-Path $funcErr) { Get-Content $funcErr -Tail 200 | ForEach-Object { Write-Host $_ } }
                throw "Functions host exited before becoming ready."
              }
            } while ((Get-Date) -lt $deadline)

            if (-not $ready) {
              Write-Host "Host not ready in time. Last 200 lines of func.out.log:" -ForegroundColor Yellow
              if (Test-Path $funcOut) { Get-Content $funcOut -Tail 200 | ForEach-Object { Write-Host $_ } }
              Write-Host "Last 200 lines of func.err.log:" -ForegroundColor Yellow
              if (Test-Path $funcErr) { Get-Content $funcErr -Tail 200 | ForEach-Object { Write-Host $_ } }
              throw "Functions host did not become ready in time."
            }

            powershell -ExecutionPolicy Bypass -File .\scripts\regression.ps1 -BaseUrl $base
            powershell -ExecutionPolicy Bypass -File .\scripts\smoke.ps1 -BaseUrl $base

          } finally {
            if ($p -and -not $p.HasExited) {
              Write-Host ("Stopping Functions host (pid={0})" -f $p.Id)
              Stop-Process -Id $p.Id -Force
            }

            Write-Host "==== func.out.log (tail 200) ===="
            if (Test-Path $funcOut) { Get-Content $funcOut -Tail 200 | ForEach-Object { Write-Host $_ } }

            Write-Host "==== func.err.log (tail 200) ===="
            if (Test-Path $funcErr) { Get-Content $funcErr -Tail 200 | ForEach-Object { Write-Host $_ } }
          }

      - name: Dump Azurite log (tail)
        if: always()
        shell: powershell
        run: |
          $azLog = Join-Path (Join-Path $env:RUNNER_TEMP "azurite") "azurite.log"
          Write-Host "==== azurite.log (tail 200) ===="
          if (Test-Path $azLog) { Get-Content $azLog -Tail 200 | ForEach-Object { Write-Host $_ } }
